<!doctype html>
<html>
	<head>
		<title>timepicker</title>
		<link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
		<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
		<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
		<style>
		.timepicker { background: white url('clockface.jpg')  no-repeat scroll center; width: 300px; height: 300px; background-size: 100% 100%;position: relative;margin-left: 100px;margin-top: 100px}
		.timepicker .hour { position: absolute;width: 10px;height: 120px;left:50%;top:50%;margin-top:-60px;margin-left:-5px;z-index: 100;cursor: pointer;}
		.timepicker .minute { position: absolute;width: 6px;height: 200px;left:50%;top:50%;margin-top:-100px;margin-left:-3px;z-index: 50;cursor: pointer;}
		.timepicker .hour .pointer { background-color: black; width: 10px; height: 60px;}
		.timepicker .minute .pointer { background-color: black; width: 6px; height: 100px;}
		.timepicker .hour .hover{background-color: red}
		.timepicker .minute .hover{background-color: red}
		.timepicker .meridiem {border:1px solid #eee;width:100px;left:50%;bottom:20%;margin-left:-50px;position: absolute;z-index:30;cursor: pointer;}
		.timepicker .meridiem .ante,  .timepicker .meridiem .post{ float: left; width: 50px; text-align: center; }
		.timepicker .meridiem .seleted { background-color: #eee;}
		.rotate {
			transform:rotate(60deg);
			-ms-transform:rotate(60deg); /* IE 9 */
			-webkit-transform:rotate(60deg); /* Safari and Chrome */
		}
		.timepicker .mask { position: absolute;width: 300px;height: 300px; z-index: 0;cursor: pointer;}
		#time {width:300px;text-align: center;font-size: 20px;margin-left: 100px;margin-top: 3px;padding: 10px;border: 2px dotted #eee;}
		</style>
		<script type="text/javascript">
		$.widget("lhn.timepicker",{



			setRotate: function(el, deg){
				el.css("transform","rotate("+deg+ "deg)");
				el.css("-webkit-transform","rotate("+deg+ "deg)");
			},

			_create: function () {
				var me = this;
				var container =  this.element;
				var mask_el = container.find(".mask");
				var hour_el = container.find(".hour");
				var hour_pt = container.find(".hour .pointer");
				var minute_el = container.find(".minute");
				var minute_pt = container.find(".minute .pointer");
				var meridiem_el = container.find(".meridiem");
				
				var moving_pt = "";

				container.disableSelection();
				meridiem_el.disableSelection();
				
				hour_pt.mousedown(function(){
					hour_pt.addClass("hover");
					mask_el.css("z-index", 1000);
					moving_pt = "hour";
				});

				minute_pt.mousedown(function(){
					minute_pt.addClass("hover");
					mask_el.css("z-index", 1000);
					moving_pt = "minute";
				});

				container.mouseup(function(){
					hour_pt.removeClass("hover");
					minute_pt.removeClass("hover");
					mask_el.css("z-index", 0);
					moving_pt = "";
				});

				container.mouseleave(function(){
					hour_pt.removeClass("hover");
					minute_pt.removeClass("hover");
					mask_el.css("z-index", 0);
					moving_pt = "";
				});

				var meridiem = "AM";
				var last_meridiem = "AM";
				meridiem_el.click(function(event){
					console.log(event.target);
					var tar = $(event.target);
					meridiem_el.find(".ante").removeClass("seleted");
					meridiem_el.find(".post").removeClass("seleted");
					tar.addClass("seleted");
					if (tar.hasClass("ante")){
						meridiem="AM";
					}else if (tar.hasClass("post")){
						meridiem="PM";
					}

					if (meridiem != last_meridiem){
						event.hour = hour;
						event.minute = minute;
						event.meridiem = meridiem;
						if (meridiem == "PM" && event.hour != 0){
							event.hour24 = hour + 12;
						}else{
							event.hour24 = hour;
						}
						me._trigger( "change", event );
					}

					last_meridiem = meridiem;
				});

				var hour_deg = 0;
				var minute_deg = 0;
				var last_deg = 0;
				var hour = 0;
				var minute = 0;
				var last_minute = 0;
				var last_hour = 0;
				mask_el.mousemove(function(event){					
				
						var x = event.pageX - container.offset().left;
						var y = event.pageY - container.offset().top;
						var w = 300;
						var h = 300;
						
						var deg = 180 - ( Math.atan( (x-w/2) / (y - h/2 ) ) )* 180 / Math.PI ;
						if (y < h/2 && x < w/2) {
							deg += 180;
						} else if (y<h/2 && x >= w/2){
							deg -= 180;
						}
						if (moving_pt == "hour"){		
							hour = 	Math.floor(hour_deg / 30);					
							hour_deg = (Math.floor(deg / 30)) * 30 + minute_deg / 12;	

							me.setRotate(hour_el, hour_deg);
							if (last_minute != minute || last_hour != hour){
								event.hour = hour;
								event.minute = minute;
								event.meridiem = meridiem;
								if (meridiem == "PM" && event.hour != 0){
									event.hour24 = hour + 12;
								}else{
									event.hour24 = hour;
								}
								me._trigger( "change", event );
							}
							last_hour = hour;
						} else if (moving_pt =="minute"){
							minute = Math.floor(deg / 6);
							minute_deg = (Math.floor(deg / 6)) * 6 ;
							hour_deg = (Math.floor(hour_deg / 30)) * 30 + minute_deg / 12;	
							if (minute < 15 && last_minute > 45){
								hour_deg = hour_deg + 30;
								if (hour == 11){
									hour = 0;
								}else{
									hour = hour + 1;
								}
							} else if (minute > 45 && last_minute < 15){
								hour_deg = hour_deg - 30;
								if (hour == 0){
									hour = 11;
								}else{
									hour = hour - 1;
								}
							}
							me.setRotate(hour_el, hour_deg);
							me.setRotate(minute_el, minute_deg);
							if (last_minute != minute || last_hour != hour){
								event.hour = hour;
								event.minute = minute;
								event.meridiem = meridiem;
								if (meridiem == "PM" && event.hour != 0){
									event.hour24 = hour + 12;
								}else{
									event.hour24 = hour;
								}
								me._trigger( "change", event );
							}
							last_minute = minute;							
						}


						console.log("x="+x +";y="+y + ";h="+hour+ ";m=" + minute);
					
				});

			}
		});

		$(function(){
			$(".timepicker").timepicker({
				change: function(e){
					$("#time").html(e.hour + ":" + e.minute + "  " + e.meridiem + " = " + e.hour24 + ":" + e.minute);
				}
			});
		});
		</script>
	</head>
	<body>
		<div id="time"></div>

		<div class="timepicker">
				<div class="meridiem"><div class="ante seleted">AM</div><div class="post">PM</div></div>
				<div class="hour"><div class="pointer"></div></div>
				<div class="minute"><div class="pointer"></div></div>
				<div class="mask"></div>
		</div>

		<div class="timepicker">
				<div class="meridiem"><div class="ante seleted">AM</div><div class="post">PM</div></div>
				<div class="hour"><div class="pointer"></div></div>
				<div class="minute"><div class="pointer"></div></div>
				<div class="mask"></div>
		</div>
	
	</body>
</html>